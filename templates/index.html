{% extends "base.html" %}
{% block title %}Home — Smart To-Do{% endblock %}
{% block content %}
<div class="row mb-3 g-3">
  <div class="col-md-3">
    <div class="stats-card">
      <div><small class="text-muted">Total</small><div class="h4">{{ stats.total }}</div></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div><small class="text-muted">Pending</small><div class="h4">{{ stats.pending }}</div></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div><small class="text-muted">Completed</small><div class="h4">{{ stats.completed }}</div></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div><small class="text-muted">Overdue</small><div class="h4">{{ stats.overdue }}</div></div>
    </div>
  </div>
</div>

<div class="card p-3 mb-3">
  <div class="d-flex gap-2">
    <input id="search" class="form-control" placeholder="Search tasks...">
    <select id="filterPriority" class="form-select" style="max-width:160px;">
      <option value="all">All priorities</option>
      <option value="High">High</option>
      <option value="Medium">Medium</option>
      <option value="Low">Low</option>
    </select>
    <a class="btn btn-outline-secondary ms-auto" href="{{ url_for('workflow') }}"><i class="bi bi-kanban"></i> Open Workflow</a>
  </div>
</div>

{% if tasks|length == 0 %}
  <div class="no-tasks">
    <div class="big">No tasks found</div>
    <div class="mb-3">Create your first task to get started!</div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal"><i class="bi bi-plus-lg"></i> Create Your First Task</button>
  </div>
{% else %}
  <div class="row" id="tasksGrid">
    {% for task in tasks %}
      <div class="col-md-4 mb-3 task-wrapper" data-title="{{ (task.title or '')|lower }}" data-desc="{{ (task.description or '')|lower }}" data-priority="{{ task.priority }}" data-complete="{{ '1' if task.complete else '0' }}">
        <div class="task-card {% if task.priority=='High' %}priority-high{% elif task.priority=='Medium' %}priority-medium{% else %}priority-low{% endif %}">
          <div style="width:48px; display:flex; align-items:center; justify-content:center;">
            <a href="{{ url_for('toggle', id=task.id) }}" style="color:inherit;">
              {% if task.complete %}
                <i class="bi bi-check-circle-fill text-success" style="font-size:1.4rem"></i>
              {% else %}
                <i class="bi bi-circle" style="font-size:1.2rem; color:#6c757d;"></i>
              {% endif %}
            </a>
          </div>
          <div style="flex:1">
            <div class="task-title">{{ task.title }}</div>
            <div class="task-desc">{{ task.description or '' }}</div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="text-muted small">
                {% if task.due_date %}
                  <i class="bi bi-calendar-event"></i> {{ task.due_date.strftime('%b %d, %Y %H:%M') }}
                {% else %}
                  No due date
                {% endif %}
              </div>
              <div class="d-flex align-items-center">
                <span class="badge {% if task.priority=='High' %}bg-danger{% elif task.priority=='Medium' %}bg-warning text-dark{% else %}bg-success{% endif %}">{{ task.priority }}</span>
                <div class="task-actions ms-2">
                  <a class="btn btn-sm btn-outline-secondary" href="#" onclick="expandCard(this,{{ task.id }}); return false;"><i class="bi bi-eye"></i></a>
                  <a class="btn btn-sm btn-outline-warning" href="{{ url_for('toggle_reminder', id=task.id) }}" title="Toggle reminder"><i class="bi bi-bell"></i></a>
                  <a class="btn btn-sm btn-outline-danger" href="{{ url_for('delete', id=task.id) }}"><i class="bi bi-trash"></i></a>
                </div>
              </div>
            </div>

            <!-- expandable details -->
            <div class="task-details mt-2" id="details-{{ task.id }}">
              <hr>
              <div><strong>Details</strong></div>
              <div class="small text-muted">{{ task.description or '—' }}</div>
              <div class="mt-2 small text-muted">Priority: {{ task.priority }} • Created: {{ task.created_at.strftime('%b %d, %Y') }}</div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  const searchInput = document.getElementById('search');
  const priorityFilter = document.getElementById('filterPriority');

  function applyFilters(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const pr = priorityFilter.value;
    document.querySelectorAll('.task-wrapper').forEach(w => {
      const title = w.dataset.title || '';
      const desc = w.dataset.desc || '';
      const priority = w.dataset.priority || '';
      let visible = true;
      if (q && !(title.includes(q) || desc.includes(q))) visible = false;
      if (pr !== 'all' && priority !== pr) visible = false;
      w.style.display = visible ? '' : 'none';
    });
  }
  [searchInput, priorityFilter].forEach(el => {
    if(el) el.addEventListener('input', applyFilters);
  });

  function expandCard(btn, id){
    const el = document.getElementById('details-'+id);
    const card = btn.closest('.task-card');
    if(!el) return;
    if(card.classList.contains('expanded')){
      card.classList.remove('expanded');
    } else {
      card.classList.add('expanded');
    }
  }
</script>
{% endblock %}
